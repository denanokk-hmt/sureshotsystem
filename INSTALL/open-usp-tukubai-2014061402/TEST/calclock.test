#!/usr/local/bin/bash -xv
#
# test script of calclock
#
# usage: ./calclock.test <python ver>

name=calclock
    
tmp=/tmp/$$
dir=$(dirname $0)/..
cd $dir
    
com="$2 ./$1/${name}"
[ "$1" = "" ] && com="./$1/${name}"

ERROR_CHECK(){
	[ "$(echo ${PIPESTATUS[@]} | tr -d ' 0')" = "" ] && return

	echo $1
	echo "$com" NG
	rm -f $tmp-*
	exit 1
}

###########################################
#TEST1

EPO=$(echo 19700101 | ${com} 1 - | awk '{print $2}')
[ "$EPO" -eq 0 ] ; ERROR_CHECK "TEST1.1 error"

EPO=$(echo 0 | ${com} -r 1 - | awk '{print $2}')
[ "$EPO" -eq 19700101000000 ] ; ERROR_CHECK "TEST1.2 error"

###########################################
#TEST2

cat << FIN > $tmp-in
0001 0000007 20060201 20060206 117 8335 -145
0001 0000007 20060203 20060206 221 15470 0
0001 0000007 20060205 20060206 85 5950 0
0001 0000007 20060206 20060206 293 20527 -17
0001 0000007 20060207 20060206 445 31150 0
0002 0000007 20060208 20060206 150 11768 -1268
0002 0000007 20060209 20060206 588 41160 0
0002 0000007 20060210 20060206 444 31080 0
FIN

cat << FIN > $tmp-ans
0001 0000007 20060201 1138752000 20060206 1139184000 117 8335 -145
0001 0000007 20060203 1138924800 20060206 1139184000 221 15470 0
0001 0000007 20060205 1139097600 20060206 1139184000 85 5950 0
0001 0000007 20060206 1139184000 20060206 1139184000 293 20527 -17
0001 0000007 20060207 1139270400 20060206 1139184000 445 31150 0
0002 0000007 20060208 1139356800 20060206 1139184000 150 11768 -1268
0002 0000007 20060209 1139443200 20060206 1139184000 588 41160 0
0002 0000007 20060210 1139529600 20060206 1139184000 444 31080 0
FIN

${com} 3 4 $tmp-in > $tmp-out
diff $tmp-ans $tmp-out
[ $? -eq 0 ] ; ERROR_CHECK "TEST2 error"

###########################################
#TEST3

cat << FIN > $tmp-in
0001 0000007 20060201 117 8335 -145
0001 0000007 20060203 221 15470 0
0001 0000007 20060205 85 5950 0
0001 0000007 20060206 293 20527 -17
0001 0000007 20060207 445 31150 0
0002 0000007 20060208 150 11768 -1268
0002 0000007 20060209 588 41160 0
0002 0000007 20060210 444 31080 0
FIN

cat << FIN > $tmp-ans
20060204
20060206
20060208
20060209
20060210
20060211
20060212
20060213
FIN

${com} 3 $tmp-in                |
awk '{print $4+86400*3}'        |
${com} -r 1 -                   |
awk '{print substr($2,1,8)}'  	> $tmp-out     
diff $tmp-ans $tmp-out
[ $? -eq 0 ] ; ERROR_CHECK "TEST3 error"

rm -f $tmp-*
echo "${com}" OK
exit 0
