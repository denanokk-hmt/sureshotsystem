<!--<!DOCTYPE html>-->
<!--<html>-->
<div id="whole" class="container opa0 fade-in tbl-x-scroll-min768"> 
     
    <!--Header Info-->
    <div class="col-md-1 col-xs-1" >
        <i class="glyphicon glyphicon-info-sign"></i>
    </div>
 
    <!--Header Info-->
    <div class="col-md10 lbl-header-info">
        <span id="info-msg" class="label label-lg label-###INFO_LV###">
            ###INFO_MSG###
        </span>
    </div>
    <!--ERROR MESSAGE-->
    <div class="row">
        <div class="col-md-10 lbl-header-info">
            <div>
                <span id="CATEGORY_NO_ISNULL_MSG" class="fade-in label label-danger ###CATEGORY_NO_ISNULL###">カテゴリ名が選択されていません。</span>
            </div>
            <div>
                <span id="OPERATION_NO_ISNULL_MSG" class="fade-in label label-danger ###OPERATION_NO_ISNULL###">作業が選択されていません。</span>
            </div>
            <div>
                <span id="OPERATION_NO_EXIST_MSG" class="fade-in label label-danger ###OPERATION_NO_EXIST###">選択した作業は存在していません。</span>
            </div>
            <div>
                <span id="OPERATION_QTY_ISNULL_MSG" class="fade-in label label-danger ###OPERATION_QTY_ISNULL###">作業工数が選択されていません。</span>
            </div>
        </div>
    </div>
    <br>

    <!--Contents Records-->
    <div class="header-under-contents">

	      <div class="row fix">
            <!--セット番号-->
            <div class="col-md-3 col-xs-3">
                <span class=" ">セットNo：</span>
                <span class=" ">###SET_NO###</span>
                <input type="hidden" id="SET_NO" name="SET_NO" value="###SET_NO###" />
                
            </div>
            <!--カテゴリ-->
            <div class="col-md-3 col-xs-3">
                <span class=" ">カテゴリ：</span>
                <span class=" ">###SET_CATEGORY_NM###</span>
            </div>
            <!--セット名-->
            <div class="col-md-3 col-xs-3">
                <span class=" ">セット名：</span>
                <span class=" ">###SET_NM###</span>
            </div>
            <!--工賃-->
            <div class="col-md-3 col-xs-3">
                <span class=" ">セット料金：</span>
                <span class=" ">###SET_PRICE###</span>
            </div>
        </div>
	  
        <!--Spacer-->
        <div class="border15"></div> 
        <div class="header-dummy" style="height:1.0em; background-color:piink;"></div>

        <!--Details--> 
        <form name="main" class=""  action="" method="">
            <input type="hidden" id="ACTION" name="ACTION" value="COMPLETE" />
            <input type="hidden" id="REST" name="REST" value="" />
            <input type="hidden" id="PAGE" name="PAGE" value="###PAGE###" />
            <input type="hidden" id="SEARCH" name="SEARH" value="0" />
            <input type="hidden" id="CATEGORY_NM" name="CATEGORY_NM" value="###CATEGORY_NM###" />
            <input type="hidden" id="CATEGORY_NO" name="CATEGORY_NO" value="###CATEGORY_NO###" />

            <ul class="nav nav-tabs">
                <li class="active">
                    <a class="tab bg-success" data-toggle="tab" href="#tab-set" value="tab-set">Set</a>
                </li>
                <li>
                    <a class="tab bg-success" data-toggle="tab" href="#tab-operation" value="tab-operation">Add Operation</a>
                </li>
                <li>
                    <a class="tab bg-success" data-toggle="tab" href="#tab-parts" value="tab-parts">Add Parts</a>
                </li>
            </ul>
            <div class="tab-content">
                <div id="tab-set" class="tab-pane fade active in">
                    <div class="header-dummy" style="height:1.0em; background-color:piink;"></div>
                    <div class="contents-table">
                        ###SET_LIST###
                    </div>
                </div>
                <div id="tab-operation" class="tab-pane fade">
                    <div class="header-dummy" style="height:1.0em; background-color:piink;"></div>
                    <div class="contents-table">
                        ###OPERATION_LIST###
                    </div>
                </div>
                <div id="tab-parts" class="tab-pane fade">
                    <div class="header-dummy" style="height:1.0em; background-color:piink;"></div>
                    <div class="contents-table">
                        ###PARTS_LIST###
                    </div>
                </div>
            </div>

        </form>
        <div class="header-dummy" style="height:10.0em; background-color:piink;"></div>
    </div>
</div>

<script>

    //Tab1の切り替え
    $('.tab').on('click', function() {
        var id = $(this).attr('value');
        $('.tab-pane').removeClass('active');
        $('.tab-pane').removeClass('in');
        $('#' + id).addClass('active');
        $('#' + id).addClass('in');
    });

    //Validation Err MSGのOpacityを初期化
    $(document).ready(function(){
        validationErrMsgInit();
    });

    //ロード時に全画面をフェードイン
    $(window).on('load',function(){
        $('#whole').css("opacity","1");
    });

    //バリデーションエラーMSGの初期化
    function validationErrMsgInit() {

        //バリデーションエラー表示をクリア
        $('input[type=text]').removeClass("label-danger");
        $('.lbl-header-info .label').removeClass("show");
        $('.lbl-header-info .label').addClass("hidden");
        $('#info-msg').html("");

        //バリデーションエラーMSGをフェードアウト
        fadeInOut(0);
    }

    /*バリデーションエラーMSGをフェードアウト
    *   引数 inout
    *   フェードイン:1
    *   フェードアウト:0
    */
    function fadeInOut(inout) {
        $('.fade-in').not('#whole').each(function(){
            $(this).css("opacity",inout );
        });
    }

    $(document).ready(function() {
        $("#pager").sticky({topSpacing:0});
    });

    //一覧画面へ遷移
    function goToList() {

        //バリデーションエラーMSG初期化
        validationErrMsgInit();

        //GETパラメーターの順番は、action,page,serach,category-nm,category-no が前提
        var action = '?action=SHOW';
        var page = '&page=' + $('#page').val();
        var search = '&search=' + $('#search').val();
        var categoryNm = '&category-nm=' + $('#CATEGORY_NM_HID_PAGE').val();
        var categoryNo = '&category-no=' + $('#CATEGORY_NO_HID_PAGE').val();

        //一覧へ 
        location.href='/APP/SET_LIST/LISTS' + action + page + search + categoryNm + categoryNo;
    }

    // 作業・部品のカテゴリを選択
    $(document).on('click', 'a.category-list', function() {

        //選択した作業のidから行を取得する
        var idname = $(this).attr("id"); 
        var kind = $(this).attr("name"); 
        var list_id = idname.split("_");
        var row = $(this).parent().parent().attr("name");
        var cat_no = list_id[2];
        var choice = $(this).text();

        //該当のレコードに選択したカテゴリ名を設定
        $('#' + kind + '_CATEGORY_NM_' + row).val(choice);
        $('#' + kind + '_CATEGORY_NM_HID_' + row).val(choice);

        //該当のレコードに選択したカテゴリ番号を設定
        $('#' + kind + '_CATEGORY_NO_HID_' + row).val(cat_no);

        //作業リストを選択したカテゴリで抽出
        var jqXHR = $.ajax({
            type: 'POST',
            url: '/APP/SET_DETAIL/SEARCH/' + kind,
            data: {
                ACTION: 'INPUT',
                CATEGORY_NO: cat_no,
                ROW: row
            }
        });
        jqXHR.done(function(data) {
            search_result = data;
            var kindL = kind.toLowerCase();
            $('#dropdown-' + kindL + '-' + row).addClass('open');
            $('#dropdown-' + kindL + '-list-' + row).html(data);
            
            //初期化
            $('#' + kind + '_NM_' + row).val('');
            $('#' + kind + '_NO_HID_' + row).val('');
            $('#' + kind + '_PRICE_' + row).val('');
            $('#' + kind + '_QTY_' + row).val('0');
            $('#' + kind + '_SUM_' + row).val('0');
        });
        jqXHR.fail(function() {
            search_result = '一致する' + kind + 'がありません。';
        });
    });

    //作業、部品リストの選択
    $(document).on('click', 'li.list-operation','li.list-parts', function() {
        //選択したリストのidから行を取得する:list-行-番号
        var idname = $(this).attr("id"); 
        var kind = $(this).attr("name"); 
        var list_id = idname.split("-");
        var row = list_id[1];
        var no = $(this).val();
        var nm = $(this).text();
        var price = $('#' + kind + '_PRICE_' + row + '_' + no).val();
        $('#' + kind + '_NM_' + row).val(nm);
        $('#' + kind + '_PRICE_' + row).val(price);
        $('#' + kind + '_QTY_' + row).val('1');
        $('#' + kind + '_SUM_' + row).val(price);
        $('#' + kind + '_NO_HID_' + row).val(no);
    });

    //作業・部品 数量PLUS
    $(document).on('click', ':button.btn-plus', function() {
        var kind = $(this).attr("name");
        var idname = $(this).attr("id"); 
        var list_id = idname.split("_");
        var row = list_id[2];
        var each = $('#' + kind + '_PRICE_' + row).val();
        if (!each) return;
        var qty = $('#' + kind + '_QTY_' + row).val();
        $('#' + kind + '_QTY_' + row).val(parseInt(qty) + parseInt(1));
        qty = $('#' + kind + '_QTY_' + row).val();
        $('#' + kind + '_SUM_' + row).val(parseInt(each) * parseInt(qty));
    });

    //作業・部品 数量MINUS
    $(document).on('click', ':button.btn-minus', function() {
        var kind = $(this).attr("name");
        var idname = $(this).attr("id"); 
        var list_id = idname.split("_");
        var row = list_id[2];
        var each = $('#' + kind + '_PRICE_' + row).val();  
        if (!each) return;
        var qty = $('#' + kind + '_QTY_' + row).val();
        if (parseInt(qty) > 1) {
            $('#' + kind + '_QTY_' + row).val(parseInt(qty) - parseInt(1));
            qty = $('#' + kind + '_QTY_' + row).val();
        }
        $('#' + kind + '_SUM_' + row).val(parseInt(each) * parseInt(qty));
    });


    //作業・部品の追加
    $(document).on('click', 'a.add', function() {

        //バリデーションエラーMSG初期化
        validationErrMsgInit();

        var idname = $(this).attr("id").split("_"); 
        var id = idname[2];
        var kind = $(this).attr("name");
        var add_name = $('#' + kind + '_NM_' + id).val();
        var jqXHR = $.ajax({
            type: 'POST',
            url: '/APP/SET_DETAIL/NEW/OPERATION',
            data: {
                ACTION: 'COMPLETE',
                REST: 'POST',
                SET_NO:$('#SET_NO').val(),
                CATEGORY_NO:$('#' + kind + '_CATEGORY_NO_HID_' + id).val(),
                CATEGORY_NM:$('#' + kind + '_CATEGORY_NM_HID_' + id).val(),
                OPERATION_NO:$('#' + kind + '_NO_HID_' + id).val(),
                OPERATION_NM:$('#' + kind + '_NM_' + id).val(),
                OPERATION_PRICE: $('#' + kind + '_PRICE_' + id).val(),
                OPERATION_QTY: $('#' + kind + '_QTY_' + id).val(),
                OPERATION_SUM: $('#' + kind + '_SUM_' + id).val()
            }
        });
        jqXHR.done(function(data) {
            //バリデーションエラーの場合、先頭にVALID=NG
            //デリミタとして「@」を指定されてくる
            var valid_result = data.split("@");
            if (valid_result[0] == 'VALID_NG') {

                //バリデーションエラー表示
                var r = validationResultDisplay('NEW', valid_result[1], 'POST');

                //バリデーションMSGをフワッと表示 
                fadeInOut(1);

                if (r != 'OK') {  
                    alert("新規登録処理に失敗しました。");
                }
            } else {
                $('table').html(data);
                $('#info-msg').html(add_name + "を追加しました。");
                alert(add_name + "を追加しました。");
            }
        });
        jqXHR.fail(function(data) {
            alert("新規登録処理に失敗しました。");
        });
    });

    //詳細変更
    function editDetail(id) {

        //バリデーションエラーMSG初期化
        validationErrMsgInit();

        var edit_name = $('#DETAIL_NAME_' + id).val();
        var jqXHR = $.ajax({
            type: 'POST',
            url: '/APP/SET_DETAIL/EDIT',
            data: {
                ACTION: 'COMPLETE',
                REST: 'PUT',
                SET_NO:$('#SET_NO').val(),
                DETAIL_NO: id,
                DETAIL_NAME: $('#DETAIL_NAME_' + id).val(),
                DETAIL_VALUE:$('#DETAIL_VALUE_' + id).val()
            }
        });
        jqXHR.done(function(data) {
            //バリデーションエラーの場合、先頭にVALID=NG
            //デリミタとして「@」を指定されてくる
            var valid_result = data.split("@");
            if (valid_result[0] == 'VALID_NG') {

                //バリデーションエラー表示
                var r = validationResultDisplay(id, valid_result[1], 'PUT');

                //バリデーションMSGをフワッと表示 
                fadeInOut(1);

                if (r != 'OK') {  
                    alert("更新処理に失敗しました。");
                }
            } else {
                $('table').html(data);
                $('#info-msg').html(edit_name + "に変更しました。");
                alert(edit_detail_name + "に変更しました。");
            }
        });
        jqXHR.fail(function() {
            alert("更新処理に失敗しました。");
        });
    }

    //詳細削除
    function deleteDetail(id) {

        //バリデーションエラーMSG初期化
        validationErrMsgInit();
 
        //削除処理
        var delete_name = $('#DETAIL_NAME_' + id).val();
        var jqXHR = $.ajax({
            type: 'POST',
            url: '/APP/SET_DETAIL/DELETE',
            data: {
                ACTION: 'COMPLETE',
                REST: 'DELETE',
                SET_NO:$('#SET_NO').val(),
                DETAIL_NO: id,
                DETAIL_NAME: $('#DETAIL_NAME_' + id).val(),
                DETAIL_VALUE:$('#DETAIL_VALUE_' + id).val()
            }
       });
        jqXHR.done(function(data) {
            if (data == 2222) {
                alert(delete_detail_name + "は、使用されていませんでした。");
            } else if (data == 111) {
                var sel = '#edit-row-' + id;
                $(sel).remove();
                $('#info-msg').html(delete_name + "を削除しました。");
                alert(delete_detail_name + "を削除しました。");
            } else {
                $('#info-msg').html(delete_name + "を削除出来ませんでした。");
                alert(delete_detail_name + "を削除出来ませんでした。");
            }
        });
        jqXHR.fail(function() {
            alert("削除処理に失敗しました。");
        });
 
    }

</script>
<!--</html>-->
