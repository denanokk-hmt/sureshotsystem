<!--<!DOCTYPE html>-->
<!--<html>-->

<div class="container">
 
    <!--Header Info& Goto subpage button-->
    <div class="fixed gray-trans-over z-index-3" style="padding:10px;">

        <!--Infomation-->
        <div class="row">
            <label class="control-label col-sm-1">
                <h3><i class="glyphicon glyphicon-info-sign"></i></h3>
            </label>
            <div class="col-sm-6 lbl-header-info">
                <span id="info-msg" class="label label-lg ">
                    ###INFO_MSG###
                </span>
            </div>
        </div>

        <!--Goto Subpage-->
        <div class="btn-toolbar">
            <button class="btn btn-subpage btn-default col-smx-3 " />Set</button>
            <button class="btn btn-subpage btn-default col-smx-3 " />Operation</button>
            <button class="btn btn-subpage btn-info col-smx-3 disabled" />Parts</button>
            <button class="btn btn-subpage btn-success col-smx-3 " />Confirm</button>
        </div>

    </div>

    <!--Spacer-->
    <div class="header-dummy" style="height:9.0em; background-color:piink;"></div>

    <!--Contents Records/Pagination-->
    <div class="header-under-contents">
        <form id="set_list" class="form-inline form-horizontal"  action="" method="">
            <div class="contents-table">
                ###TABLE###
            </div>
       </form>
    </div>
</div>

<script>

/*
    $(document).ready(function() {
        $("#pager").sticky({topSpacing:0});
    });
*/

    //ページ移動
    $(".btn-toolbar .btn-subpage").on('click', function() {
        var func = $(this).html().toUpperCase();
        var frm = document.forms['set_list'];
        frm.method = 'GET';
        frm.action = '/APP/SET_LIST/NEW/' + func + '/INPUT';
        frm.submit();
    });

    //カテゴリを選択
    $(document).on('click', 'a.category-list', function() {
        
        //選択カテゴリを取得する
        var kindU = $(this).parent().attr("name");        
        var kindL = $(this).parent().attr("name").toLowerCase();        

        //SEARCH用URLを設定
        search_url = '/APP/' + kindU + '_LIST/SEARCH/INPUT';

        //選択した部品のidから行を取得する
        var idname = $(this).attr("id"); 
        var list_id = idname.split("_");
        var row = $(this).parent().parent().attr("name");
        var cat_no = list_id[2];
        var choice = $(this).text();

        //該当のレコードに選択したカテゴリ名を設定
        $('#' + kindU + '_CATEGORY_NM_' + row).val(choice);
        $('#' + kindU + '_CATEGORY_NM_HID_' + row).val(choice);

        //該当のレコードに選択したカテゴリ番号を設定
        $('#' + kindU + '_CATEGORY_NO_HID_' + row).val(cat_no);

        if (kindU != 'PAGE' && kindU != 'SET') {

            //選択したカテゴリで抽出
            var jqXHR = $.ajax({
                type: 'POST',
                url: search_url,
                data: {
                    CATEGORY_NO: cat_no,
                    ROW: row
                }
            });
            jqXHR.done(function(data) {
                search_result = data;
                $('#dropdown-' + kindL + '-' + row).addClass('open');
                $('#dropdown-' + kindL + '-list-' + row).html(data);
                
                //クリア
                $('#' + kindU + '_NM_' + row).val('');
                $('#' + kindU + '_NO_HID_' + row).val('');
                $('#' + kindU + '_PRICE_' + row).val('');
                if (kindU == 'PARTS') {
                    $('#PARTS_QTY_' + row).val('0');
                }
                if (row != 'PAGE' && row != 'NEW') {
                    $('#' + kindU + '_NX_HID_' + row).val('');
                }
            });
            jqXHR.fail(function() {
                search_result = '一致するパーツがありません。';
            });
        }
    });

    //登録済部品名ボタン押下
    $(document).on('click', 'button.parts', function() {

        //選択カテゴリを取得する
        var kindU = $(this).parent().attr("name");        
        var kindL = $(this).parent().attr("name").toLowerCase();        

        //SEARCH用URLを設定
        search_url = '/APP/' + kindU + '_LIST/SEARCH/INPUT';

        //選択した部品のidから行を取得する
        var idname = $(this).attr("id"); 
        var list_id = idname.split("_");
        var row = list_id[1];
        var cat_no = $('#' + kindU + '_CATEGORY_NO_HID_' + row).val();

        //選択したカテゴリで抽出
        var jqXHR = $.ajax({
            type: 'POST',
            url: search_url,
            data: {
                CATEGORY_NO: cat_no,
                ROW: row
            }
        });
        jqXHR.done(function(data) {
            search_result = data;
            $('#dropdown-' + kindL + '-' + row).addClass('open');
            $('#dropdown-' + kindL + '-list-' + row).html(data);
       });
        jqXHR.fail(function() {
            search_result = '一致するパーツがありません。';
        });
    });

    //部品選択
    $(document).on('click', 'li.list-parts,li.list-parts', function() {

        var kind = $(this).parent().parent().attr("name");

        //選択したリストのidから行を取得する:list-行-部品番号
        var idname = $(this).attr("id"); 
        var list_id = idname.split("-");
        var row = list_id[1];
        var itemNo = $(this).val();
        var itemNm = $(this).text();
        var itemPrice = $('#' + kind + '_PRICE_' + row + '_' + itemNo).val();
        $('#' + kind + '_NM_' + row).val(itemNm);
        $('#' + kind + '_PRICE_' + row).val(itemPrice);
        $('#' + kind + '_QTY_' + row).val('1');
        $('#' + kind + '_NO_HID_' + row).val(itemNo);
    });

    //部品 数量PLUS
    $(document).on('click', ':button.btn-plus', function() {
        var kind = $(this).attr("name");
        var idname = $(this).attr("id"); 
        var list_id = idname.split("_");
        var row = list_id[2];
        var qty = $('#' + kind + '_QTY_' + row).val();
        if (!qty) return;
        var subTTL = $('#' + kind + '_PRICE_' + row).val();
        var each = parseInt(subTTL) / parseInt(qty);
        $('#' + kind + '_QTY_' + row).val(parseInt(qty) + parseInt(1));
        qty = $('#' + kind + '_QTY_' + row).val();
        $('#' + kind + '_PRICE_' + row).val(parseInt(each) * parseInt(qty));
    });

    //部品 数量MINUS
    $(document).on('click', ':button.btn-minus', function() {
        var kind = $(this).attr("name");
        var idname = $(this).attr("id"); 
        var list_id = idname.split("_");
        var row = list_id[2];
        var qty = $('#' + kind + '_QTY_' + row).val();
        if (!qty) return;
        var subTTL = $('#' + kind + '_PRICE_' + row).val();
        var each = parseInt(subTTL) / parseInt(qty);
        if (parseInt(qty) > 1) {
            $('#' + kind + '_QTY_' + row).val(parseInt(qty) - parseInt(1));
            qty = $('#' + kind + '_QTY_' + row).val();
        }
        $('#' + kind + '_PRICE_' + row).val(parseInt(each) * parseInt(qty));
    });

    //ADD.EDIT.DELETEボタン
    $(document).on('click', 'a.btn-parts', function() {

        //イベント基本情報
        //selecter id format: kind_action_row
        var idname = $(this).attr("id"); 
        var list_id = idname.split("_");
        var action = list_id[1];
        var row = list_id[2];

        //CLEAR->Newをクリア
        if (action == 'CLEAR') {
            $('#PARTS_CATEGORY_NO_HID_'+ row).val("");
            $('#PARTS_CATEGORY_NM_' + row).val("");
            $('#PARTS_NO_HID_' + row).val("");
            $('#PARTS_NM_' + row).val("");
            $('#PARTS_PRICE_' + row).val("");
            $('#PARTS_QTY_' + row).val("");
            return;
        }
      
        //値
        var parts_category_no = $('#PARTS_CATEGORY_NO_HID_' + row).val();
        var parts_category_nm = $('#PARTS_CATEGORY_NM_' + row).val();
        var parts_no = $('#PARTS_NO_HID_' + row).val();
        var parts_nm = $('#PARTS_NM_' + row).val();
        var parts_price = $('#PARTS_PRICE_' + row).val();
        var parts_qty = $('#PARTS_QTY_' + row).val();

        //Validation
        if (!parts_category_no) {
            alert("部品カテゴリが選択されていません。");
            return;
        }
        //Validation
        if (!parts_no) {
            alert("部品が選択されていません。");
            return;
        }

        //仮登録の登録・更新・削除
        var jqXHR = $.ajax({
            type: 'POST',
            url: '/APP/SET_LIST/NEW/PARTS/COMPLETE',
            data: {
              ACTION: action,
              ROW: row,
              PARTS_CATEGORY_NO: parts_category_no,
              PARTS_CATEGORY_NM: parts_category_nm,
              PARTS_NO: parts_no,
              PARTS_NM: parts_nm,
              PARTS_PRICE: parts_price,
              PARTS_QTY: parts_qty
            }
        });
        jqXHR.done(function(data) {
            if (data == 2222) {
                alert("部品" + row + "の" + action + "が出来ませんでした。");
            } else {
                $('intput[type="text"]').each(function() {
                });
                $('table').html(data);
            }
        });
        jqXHR.fail(function(data) {
            alert("部品" + row + "の" + action + "に失敗しました。");
        });
    });

    //SETボタン
    $(document).on('click', 'a.btn-set', function() {

        var jqXHR = $.ajax({
            type: 'POST',
            url: '/APP/SET_LIST/NEW/COMPLETE',
       });
        jqXHR.done(function(data) {
            alert("セットを登録しました。");
            location.href = '/APP/SET_LIST/LISTS/SHOW';
        });
        jqXHR.fail(function(data) {
            alert("セットの登録が出来ませんでした。");
        });
    });

</script>
<!--</html>-->
