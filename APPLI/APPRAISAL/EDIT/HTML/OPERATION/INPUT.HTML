<!--<!DOCTYPE html>-->
<!--<html>-->
<div class="container">
    
    <div class="fixed gray-trans-over z-index-3" style="padding:10px;">

        <!--Header Info-->
        <div class="row">
            <div class="col-sm-6 lbl-header-info">
                <span id="info-msg" class="label label-lg ">
                    ###INFO_MSG###
                </span>
                 <span id="appraisal-info" class="label label-lg ">
                    ###APPRAISAL_INFO###
                </span>
                <span id="customer-info" class="label label-lg ">
                    ###CUSTOMER_INFO###
                </span>
            </div>
        </div>
        <br>
       <!--Goto Another Function-->
        <div class="btn-toolbar">
            <button class="btn btn-default col-smx-3" />Customer</button>
            <button class="btn btn-info col-smx-3 disabled" />Operation</button>
            <button class="btn btn-default col-smx-3 " />Parts</button>
            <button class="btn btn-default col-smx-3" />Set</button>
            <button class="btn btn-success col-smx-3" />Confirm</button>
        </div>
    </div>
</div>

<!--Spacer-->
<div class="header-dummy" style="height:9.0em; background-color:piiink;"></div>

<!--Contents Records-->
<div class="container">
    <div class="row">
        <div class="contents-table">
            ###TABLE###
        </div>
    </div>
</div>

<div class="container">
    <div class="row">
        <!--Contents-->
        <div class="col-md-4">
            <div class="contents">
                <form name="assessment" action="" method="">
            		    <input type="hidden" id="APPRAISAL_NO" name="APPRAISAL_NO" value="###APPRAISAL_NO###" />
                </form>
            		<input type="hidden" id="TEMP_NO" name="TEMP_NO" value="###TEMP_NO###" />
            </div>
        </div>
    </div>

    <!--強制リダイレクト指示-->
    <input type="hidden" id="redirect-force" name="redirect-force" value="###REDIRECT_FORCE###" />
</div>

<script>

    //エラーによる強制リダイレクト指示
    $(document).ready(function(){
        redirect = $('#redirect-force').val();
        if (redirect) {
          location.href = redirect;
        }
    });

    //HEADページ移動
    $(".btn-toolbar .btn").on('click', function() {
        var temp_no = $("#TEMP_NO").val();
        var func = $(this).html().toUpperCase();
        var frm = document.forms['assessment'];
        frm.method = 'GET';
        frm.action = '/APP/APPRAISAL/EDIT/' + func + '/INPUT'
        frm.submit();
    });

    //カテゴリを選択
    $(document).on('click', 'a.category-list', function() {

        //選択した作業のidから行を取得する
        var idname = $(this).attr("id"); 
        var list_id = idname.split("_");
        var row = $(this).parent().parent().attr("name");
        var cat_no = list_id[2];
        var choice = $(this).text();

        //該当のレコードに選択したカテゴリ名を設定
        $('#CATEGORY_NM_' + row).val(choice);
        $('#CATEGORY_NM_HID' + row).val(choice);

        //該当のレコードに選択したカテゴリ番号を設定
        var input_hidden = document.getElementById('CATEGORY_NO_HID_' + row);
        input_hidden.value = cat_no;

        //作業リストを選択したカテゴリで抽出
        var jqXHR = $.ajax({
            type: 'POST',
            url: '/APP/OPERATION_LIST/SEARCH/INPUT',
            data: {
                CATEGORY_NO: cat_no,
                ROW: row
            }
        });
        jqXHR.done(function(data) {
            search_result = data;
            $('#dropdown-operation-' + row).addClass('open');
            $('#dropdown-operation-list-' + row).html(data);
            //作業をクリア
            $('#OPERATION_NM_' + row).val('');
            $('#OPERATION_NO_HID_' + row).val('');
            $('#OPERATION_PRICE_' + row).val('');
            $('#OPERATION_QTY_' + row).val('0');
        });
        jqXHR.fail(function() {
            search_result = '一致する作業がありません。';
        });
    });

    //登録済の作業リストの取得
    $(document).on('click', ':button.btn-operation', function() {
        var row = $(this).attr("name");
        var cat_no = $('#CATEGORY_NO_HID_' + row).val();
        var deferred = ajax_func();
        deferred.done(function() {
          //done!!
        });

        //作業リストを選択したカテゴリで抽出
        function ajax_func() {
            var deferred = new $.Deferred();
            $.ajax({
                type: 'POST',
                url: '/APP/OPERATION_LIST/SEARCH/INPUT',
                data: {
                    CATEGORY_NO: cat_no,
                    ROW: row
                }
            }).done(function(data) {
                search_result = data;
                $('#dropdown-operation-' + row).addClass('open');
                $('#dropdown-operation-list-' + row).html(data);
            }).fail(function() {
                search_result = '一致する作業がありません。';
            }).always(function() {
                deferred.resolve();
            });
            return deferred;
        }
    });


    //作業選択
    $(document).on('click', 'li.list-operation', function() {

        //選択したリストのidから行を取得する:list-行-作業番号
        var idname = $(this).attr("id"); 
        var list_id = idname.split("-");
        var row = list_id[1];
        var operationNo = $(this).val();
        var operationNm = $(this).text();
        var operationPrice = $('#OPERATION_PRICE_' + row + '_' + operationNo).val();
        $('#OPERATION_NM_' + row).val(operationNm);
        $('#OPERATION_PRICE_' + row).val(operationPrice);
        $('#OPERATION_QTY_' + row).val('1');
        $('#OPERATION_NO_HID_' + row).val(operationNo);
    });

    //作業 数量PLUS
    $(document).on('click', ':button.btn-plus', function() {
        var kind = $(this).attr("name");
        var idname = $(this).attr("id"); 
        var list_id = idname.split("_");
        var row = list_id[2];
        var qty = $('#' + kind + '_QTY_' + row).val();
        if (!qty) return;
        var subTTL = $('#' + kind + '_PRICE_' + row).val();
        var each = parseInt(subTTL) / parseInt(qty);
        $('#' + kind + '_QTY_' + row).val(parseInt(qty) + parseInt(1));
        qty = $('#' + kind + '_QTY_' + row).val();
        $('#' + kind + '_PRICE_' + row).val(parseInt(each) * parseInt(qty));
    });

    //作業 数量MINUS
    $(document).on('click', ':button.btn-minus', function() {
        var kind = $(this).attr("name");
        var idname = $(this).attr("id"); 
        var list_id = idname.split("_");
        var row = list_id[2];
        var qty = $('#' + kind + '_QTY_' + row).val();
        if (!qty) return;
        var subTTL = $('#' + kind + '_PRICE_' + row).val();
        var each = parseInt(subTTL) / parseInt(qty);
        if (parseInt(qty) > 1) {
            $('#' + kind + '_QTY_' + row).val(parseInt(qty) - parseInt(1));
            qty = $('#' + kind + '_QTY_' + row).val();
        }
        $('#' + kind + '_PRICE_' + row).val(parseInt(each) * parseInt(qty));
    });

    //作業追加・変更・削除
    $(document).on('click', 'a.btn-operation', function() {
        //基本情報
        var idname = $(this).attr("id"); 
        var list_id = idname.split("_");
        var action = list_id[1];
        var row = list_id[2];
        //入力情報
        var appraisal_no = $('#APPRAISAL_NO').val();
        var temp_no = $('#TEMP_NO').val();
        var category_no = $('#CATEGORY_NO_HID_' + row).val();
        var category_nm = $('#CATEGORY_NM_' + row).val();
        var operation_no = $('#OPERATION_NO_HID_' + row).val();
        var operation_nm = $('#OPERATION_NM_' + row).val();
        var operation_price = $('#OPERATION_PRICE_' + row).val();
        var operation_qty = $('#OPERATION_QTY_' + row).val();

        var jqXHR = $.ajax({
            type: 'POST',
            url: '/APP/APPRAISAL/EDIT/OPERATION/COMPLETE',
            data: {
              ACTION: action,
              ROW: row,
              APPRAISAL_NO: appraisal_no,
              TEMP_NO: temp_no,
              CATEGORY_NO: category_no,
              CATEGORY_NM: category_nm,
              OPERATION_NO: operation_no,
              OPERATION_NM: operation_nm,
              OPERATION_PRICE: operation_price,
              OPERATION_QTY: operation_qty
            }
        });
        jqXHR.done(function(data) {
            if (data == 2222) {
                alert("作業:" + row + "の" + action + "が出来ませんでした。");
            } else {
                $('intput[type="text"]').each(function() {
                });
                $('table').html(data);
                alert("作業: " + row + "を" + action + "しました。");
            }
        });
        jqXHR.fail(function(data) {
            alert(action + "処理に失敗しました。");
        });
    });


</script>
<!--</html>-->
