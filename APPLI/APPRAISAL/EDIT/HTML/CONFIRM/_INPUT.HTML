<!--<!DOCTYPE html>-->
<!--<html>-->
<div class="container">
    
    <div class="fixed gray-trans-over z-index-3" style="padding:10px;">

        <!--Header Info-->
        <div class="row">
            <div class="col-sm-6 lbl-header-info">
                <span id="info-msg" class="label label-lg ">
                    ###INFO_MSG###
                </span>
                 <span id="appraisal-info" class="label label-lg ">
                    ###APPRAISAL_INFO###
                </span>
                <span id="customer-info" class="label label-lg ">
                    ###CUSTOMER_INFO###
                </span>
            </div>
        </div>
        <br>
        <!--Goto Another Function-->
        <div class="btn-toolbar">
            <button class="btn btn-default col-smx-3" />Customer</button>
            <button class="btn btn-default col-smx-3" />Operation</button>
            <button class="btn btn-info col-smx-3 disabled" />Parts</button>
            <button class="btn btn-default col-smx-3" />Set</button>
            <button class="btn btn-success col-smx-3" />Confirm</button>
        </div>

    </div>
</div>

<!--Spacer-->
<div class="header-dummy" style="height:9.0em; background-color:piiink;"></div>

<!--Contents Records-->
<div class="container">
    <div class="row">
        <div class="contents-table">
            ###TABLE###
        </div>
    </div>
</div>

<div class="container">
    <div class="row">
        <!--Contents-->
        <div class="col-md-4">
            <div class="contents">
                <form name="assessment" action="" method="">
            		    <input type="hidden" id="TEMP_NO" name="TEMP_NO" value="###TEMP_NO###" />
                </form>
           </div>
        </div>
    </div>

    <!--強制リダイレクト指示-->
    <input type="hidden" id="redirect-force" name="redirect-force" value="###REDIRECT_FORCE###" />
</div>

<script>

    //エラーによる強制リダイレクト指示
    $(document).ready(function(){
        redirect = $('#redirect-force').val();
        if (redirect) {
          location.href = redirect;
        }
    });
 
    //HEADページ移動
    $(".btn-toolbar .btn").on('click', function() {
        var temp_no = $("#TEMP_NO").val();
        var func = $(this).html().toUpperCase();
        var frm = document.forms['assessment'];
        frm.method = 'GET';
        frm.action = '/APP/APPRAISAL/NEW/' + func + '/INPUT' + '?temp_no=' + temp_no;
        frm.submit();
    });

    //カテゴリを選択
    $(document).on('click', 'a.category-list', function() {

        //選択した部品のidから行を取得する
        var idname = $(this).attr("id"); 
        var list_id = idname.split("_");
        var row = $(this).parent().parent().attr("name");
        var cat_no = list_id[2];
        var choice = $(this).text();

        //該当のレコードに選択したカテゴリ名を設定
        $('#CATEGORY_NM_' + row).val(choice);
        $('#CATEGORY_NM_HID_' + row).val(choice);

        //該当のレコードに選択したカテゴリ番号を設定
        $('#CATEGORY_NO_HID_' + row).val(cat_no);

        //パーツリストを選択したカテゴリで抽出
        var jqXHR = $.ajax({
            type: 'POST',
            url: '/APP/PARTS_LIST/SEARCH/INPUT',
            data: {
                CATEGORY_NO: cat_no,
                ROW: row
            }
        });
        jqXHR.done(function(data) {
            search_result = data;
            $('#dropdown-parts-' + row).addClass('open');
            $('#dropdown-parts-list-' + row).html(data);
            //パーツをクリア
            $('#PARTS_NM_' + row).val('');
            $('#PARTS_NO_HID_' + row).val('');
            $('#PARTS_PRICE_' + row).val('');
            $('#PARTS_QTY_' + row).val('0');
        });
        jqXHR.fail(function() {
            search_result = '一致するパーツがありません。';
        });
    });

    //登録済のパーツリストの取得
    $(document).on('click', ':button.btn-parts', function() {
        var row = $(this).attr("name");
        var cat_no = $('#CATEGORY_NO_HID_' + row).val();
        var deferred = ajax_func();
        deferred.done(function() {
          //done!!
        });

        //パーツリストを選択したカテゴリで抽出
        function ajax_func() {
            var deferred = new $.Deferred();
            $.ajax({
                type: 'POST',
                url: '/APP/PARTS_LIST/SEARCH/INPUT',
                data: {
                    CATEGORY_NO: cat_no,
                    ROW: row
                }
            }).done(function(data) {
                search_result = data;
                $('#dropdown-parts-' + row).addClass('open');
                $('#dropdown-parts-list-' + row).html(data);
            }).fail(function() {
                search_result = '一致するパーツがありません。';
            }).always(function() {
                deferred.resolve();
            });
            return deferred;
        }
    });


    //パーツ選択
    $(document).on('click', 'li.list-parts', function() {

        //選択したリストのidから行を取得する:list-行-部品番号
        var idname = $(this).attr("id"); 
        var list_id = idname.split("-");
        var row = list_id[1];
        var partsNo = $(this).val();
        var partsNm = $(this).text();
        var partsPrice = $('#PARTS_PRICE_' + row + '_' + partsNo).val();
        $('#PARTS_NM_' + row).val(partsNm);
        $('#PARTS_PRICE_' + row).val(partsPrice);
        $('#PARTS_QTY_' + row).val('1');
        $('#PARTS_NO_HID_' + row).val(partsNo);
    });

    //部品 数量PLUS
    $(document).on('click', ':button.btn-plus', function() {
        var kind = $(this).attr("name");
        var idname = $(this).attr("id"); 
        var list_id = idname.split("_");
        var row = list_id[2];
        var qty = $('#' + kind + '_QTY_' + row).val();
        if (!qty) return;
        var subTTL = $('#' + kind + '_PRICE_' + row).val();
        var each = parseInt(subTTL) / parseInt(qty);
        $('#' + kind + '_QTY_' + row).val(parseInt(qty) + parseInt(1));
        qty = $('#' + kind + '_QTY_' + row).val();
        $('#' + kind + '_PRICE_' + row).val(parseInt(each) * parseInt(qty));
    });

    //部品 数量MINUS
    $(document).on('click', ':button.btn-minus', function() {
        var kind = $(this).attr("name");
        var idname = $(this).attr("id"); 
        var list_id = idname.split("_");
        var row = list_id[2];
        var qty = $('#' + kind + '_QTY_' + row).val();
        if (!qty) return;
        var subTTL = $('#' + kind + '_PRICE_' + row).val();
        var each = parseInt(subTTL) / parseInt(qty);
        if (parseInt(qty) > 1) {
            $('#' + kind + '_QTY_' + row).val(parseInt(qty) - parseInt(1));
            qty = $('#' + kind + '_QTY_' + row).val();
        }
        $('#' + kind + '_PRICE_' + row).val(parseInt(each) * parseInt(qty));
    });


    //パーツ追加
    $(document).on('click', 'a.btn-parts', function() {

        var idname = $(this).attr("id"); 
        var list_id = idname.split("_");
        var action = list_id[1];
        var row = list_id[2];

        var temp_no = $('#TEMP_NO').val();
        var category_no = $('#CATEGORY_NO_HID_' + row).val();
        var category_nm = $('#CATEGORY_NM_' + row).val();
        var parts_no = $('#PARTS_NO_HID_' + row).val();
        var parts_nm = $('#PARTS_NM_' + row).val();
        var parts_price = $('#PARTS_PRICE_' + row).val();
        var parts_qty = $('#PARTS_QTY_' + row).val();

        var jqXHR = $.ajax({
            type: 'POST',
            url: '/APP/APPRAISAL/NEW/PARTS/COMPLETE',
            /*
            data: { 
              params,
              TEMP_NO: temp_no
            }
            */
            data: {
              ACTION: action,
              ROW: row,
              TEMP_NO: temp_no,
              CATEGORY_NO: category_no,
              CATEGORY_NM: category_nm,
              PARTS_NO: parts_no,
              PARTS_NM: parts_nm,
              PARTS_PRICE: parts_price,
              PARTS_QTY: parts_qty
            }
        });
        jqXHR.done(function(data) {
            if (data == 2222) {
                alert("パーツの追加が出来ませんでした。");
            } else {
                $('intput[type="text"]').each(function() {
                });
                $('table').html(data);
            }
        });
        jqXHR.fail(function(data) {
            alert("新規登録処理に失敗しました。");
        });
    });


</script>
<!--</html>-->
